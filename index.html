<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pass Scan — Validate & Register</title>
<style>
  :root{--accent:#0b6cff;--muted:#6b7280;--card:#fff;--danger:#d9534f}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f7f8ff,#fff);color:#071127;padding:20px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:920px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(12,20,40,0.06);display:grid;grid-template-columns:380px 1fr;gap:18px}
  @media(max-width:880px){.card{grid-template-columns:1fr}}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#6b46ff,#4c33cc);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{margin:0;font-size:1.05rem}
  .subtitle{margin:0;color:var(--muted);font-size:0.9rem}

  .videoWrap{position:relative;border-radius:10px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;height:320px}
  video{width:100%;height:100%;object-fit:cover;display:block}
  .overlay{position:absolute;inset:12px;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .scanBox{width:64%;max-width:260px;aspect-ratio:1;border-radius:12px;border:2px dashed rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.85);font-weight:700;backdrop-filter:blur(4px)}
  .pulse{position:absolute;width:calc(64% + 28px);height:calc(64% + 28px);border-radius:16px;opacity:0.12;background:radial-gradient(circle,#6b46ff,transparent);animation:pulse 2s infinite}
  @keyframes pulse{0%{transform:scale(.98)}50%{transform:scale(1.03)}100%{transform:scale(.98)}}

  .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600;background:#fff;box-shadow:0 6px 18px rgba(12,20,40,0.06)}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:1px solid #eef2ff;color:var(--accent)}

  .small{font-size:0.88rem;color:var(--muted)}

  aside.panel{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.6))}
  .kv{display:flex;align-items:center;gap:8px;margin:8px 0}
  .chip{background:#fff;padding:6px 10px;border-radius:999px;border:1px solid #f0efff;color:var(--accent);font-weight:700}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,6,23,0.28),rgba(2,6,23,0.5));z-index:9999}
  .modal.show{display:flex}
  .modal .box{background:#fff;padding:20px;border-radius:12px;max-width:460px;width:92%;text-align:center}
  .invalid{color:var(--danger);font-weight:700}

  input[type="text"]{padding:10px;border-radius:10px;border:1px solid #eee;flex:1}

  footer{margin-top:12px;color:var(--muted);font-size:0.9rem}

  #loadingOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
}

.loader {
  width: 48px;
  height: 48px;
  border: 5px solid rgba(255,255,255,0.3);
  border-top-color: #ffffff;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

  
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Pass scanner and validator">

      <div>
        <header>
          <div class="logo">BK</div>
          <div>
            <h1>BK Shivani — Pass Scan</h1>
            <p class="subtitle small">Scan the physical pass QR. The app will validate the pass before opening the registration form.</p>
          </div>
        </header>

        <div class="videoWrap" style="margin-top:12px">
          <video id="video" playsinline muted aria-label="camera preview"></video>
          <div class="overlay" aria-hidden="true">
            <div class="pulse"></div>
            <div class="scanBox">Align QR here</div>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn" class="btn primary">Start scanner</button>
          <button id="stopBtn" class="btn" style="display:none">Stop</button>
          <button id="flipBtn" class="btn" style="display:none">Flip camera</button>
          <button id="torchBtn" class="btn" style="display:none">Torch</button>
          <div style="flex:1"></div>
          <div id="status" class="small">Status: idle</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <input id="manualInput" type="text" placeholder="Paste pass code manually" />
          <button id="manualGo" class="btn">Open Form</button>
        </div>

        <p class="small" style="margin-top:12px">Camera runs locally in the browser; no video is uploaded. If camera is blocked, enable permission in your browser settings.</p>
      </div>

      <aside class="panel" aria-hidden="false">
        <h3>How it works</h3>
        <p class="small">Scan the code printed on the pass. The app validates the code with the admin list and then opens the registration form with the pass number pre-filled.</p>

        <div class="kv"><div class="chip">Validated</div><div class="small">Each QR is checked against the admin list.</div></div>
        <div class="kv"><div class="chip">Privacy</div><div class="small">We do not upload camera streams. Collected data goes to Google Forms.</div></div>

        <hr style="border:none;border-top:1px solid #f2f3fb;margin:12px 0" />
      </aside>
    </div>

    <div id="loadingOverlay">
      <div class="loader"></div>
      <p>Validating pass…</p>
    </div>  


    <div id="validModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="validTitle">
      <div class="box">
        <h3 id="validTitle">Pass validated</h3>
        <p id="validTxt" class="small" style="margin-top:8px"></p>
        <div style="margin-top:14px;display:flex;gap:10px;justify-content:center">
          <button id="openFormBtn" class="btn primary">Open Form</button>
          <button id="scanAgainBtn" class="btn">Scan another</button>
        </div>
      </div>
    </div>

    <div id="invalidModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="invalidTitle">
      <div class="box">
        <h3 id="invalidTitle" class="invalid">Invalid pass</h3>
        <p id="invalidTxt" class="small" style="margin-top:8px"></p>
        <div style="margin-top:14px;display:flex;gap:10px;justify-content:center">
          <button id="retryBtn" class="btn">Retry</button>
          <button id="manualBtn" class="btn ghost">Enter Manually</button>
        </div>
      </div>
    </div>
  </div>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
/* ============ CONFIG ============ */
const GOOGLE_FORM_PREFILL_URL = "https://docs.google.com/forms/d/e/1FAIpQLScpuyjR36_M689jdxRBxgpSXa-J6UasLwsxJ-NTFfxzzYiBWg/viewform?usp=pp_url&entry.298461775=";
const VERIFY_URL = "https://script.google.com/macros/s/AKfycbyOMcJwpq95bO6i6CXhP808afQhhGMmr-ViZ7DOaXGzpz68NSgblnPYZYtZfnpQE5SKMw/exec";
/* ================================= */

const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const flipBtn = document.getElementById('flipBtn');
const torchBtn = document.getElementById('torchBtn');
const status = document.getElementById('status');
const manualInput = document.getElementById('manualInput');
const manualGo = document.getElementById('manualGo');

const validModal = document.getElementById('validModal');
const validTxt = document.getElementById('validTxt');
const openFormBtn = document.getElementById('openFormBtn');
const scanAgainBtn = document.getElementById('scanAgainBtn');

const invalidModal = document.getElementById('invalidModal');
const invalidTxt = document.getElementById('invalidTxt');
const retryBtn = document.getElementById('retryBtn');
const manualBtn = document.getElementById('manualBtn');

let stream = null;
let scanning = false;
let decodeInterval = null;
let useFacing = 'environment';
let currentTrack = null;
let lastScanned = null;

/* small in-memory cache for verified ids to reduce calls */
const verifyCache = new Map(); // id -> {valid:true, ts: epoch}

/* helpers */
function setStatus(txt, isError=false){
  status.textContent = 'Status: ' + txt;
  status.style.color = isError ? 'var(--danger)' : 'var(--accent)';
}

function showValidModal(code){
  validTxt.textContent = code;
  validModal.classList.add('show');
  openFormBtn.onclick = () => {
    window.location.href = GOOGLE_FORM_PREFILL_URL + encodeURIComponent(code);
  };
  scanAgainBtn.onclick = () => {
    validModal.classList.remove('show');
    lastScanned = null;
    startScanner();
  };
}

  function showLoader() {
  document.getElementById("loadingOverlay").style.display = "flex";
}

function hideLoader() {
  document.getElementById("loadingOverlay").style.display = "none";
}


function showInvalidModal(msg){
  invalidTxt.textContent = msg;
  invalidModal.classList.add('show');
  retryBtn.onclick = () => {
    invalidModal.classList.remove('show');
    lastScanned = null;
    startScanner();
  };
  manualBtn.onclick = () => {
    invalidModal.classList.remove('show');
    manualInput.focus();
  };
}

/* verify via Apps Script endpoint */
async function verifyId(id){
  // check cache first (cache for 5 minutes)
  const cached = verifyCache.get(id);
  const now = Date.now();
  if(cached && (now - cached.ts) < 5 * 60 * 1000) return cached.valid;

  try {
    const resp = await fetch(VERIFY_URL + '?id=' + encodeURIComponent(id), {cache: 'no-store'});
    if(!resp.ok) {
      console.warn('verify: non-200', resp.status);
      return null;
    }
    const j = await resp.json();
    const valid = !!j.valid;
    verifyCache.set(id, {valid, ts: now});
    return valid;
  } catch (e){
    console.error('verify error', e);
    return null; // network or other error
  }
}

/* frame decoding loop using jsQR */
function decodeFrame(){
  if(!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
  const w = video.videoWidth, h = video.videoHeight;
  if(!w || !h) return;
  const canvas = decodeFrame._canvas || (decodeFrame._canvas = document.createElement('canvas'));
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);
  try {
    const imageData = ctx.getImageData(0,0,w,h);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
    if(code && code.data){
      const val = String(code.data).trim();
      if(!val) return;
      // debounce same code
      if(lastScanned && lastScanned === val) return;
      lastScanned = val;
      stopScanner(); // pause camera while validating
      setStatus('Validating pass...');
      showLoader();
      verifyId(val).then(result => {
        hideLoader();
        if(result === true){
          setStatus('Pass validated');
          showValidModal(val);
        } else if(result === false){
          setStatus('Pass invalid', true);
          showInvalidModal('This pass code is not recognized or has been revoked.');
        } else { // null = network/unknown
          setStatus('Validation failed (network). Try again.', true);
          showInvalidModal('Validation could not be completed due to network error. Retry or enter manually.');
        }
      }).catch(err=>{
        hideLoader();
        console.error('verify catch', err);
        setStatus('Validation failed', true);
        showInvalidModal('Validation could not be completed. Retry or enter manually.');
      });
    }
  } catch(e){
    // ignore decoding exceptions
  }
}

/* start / stop camera */
async function startScanner(){
  if(scanning) return;
  setStatus('Requesting camera...');
  try {
    const constraints = { video: { facingMode: { ideal: useFacing }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    scanning = true;
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    flipBtn.style.display = 'inline-block';
    setStatus('Camera live — scanning...');
    currentTrack = stream.getVideoTracks()[0];

    // show torch if supported
    try {
      const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
      if(caps && caps.torch) torchBtn.style.display = 'inline-block';
      else torchBtn.style.display = 'none';
    } catch(e){ torchBtn.style.display = 'none' }

    decodeInterval = setInterval(decodeFrame, 180);
  } catch (err) {
    console.error('startScanner error', err);
    const name = err && err.name ? err.name : err;
    setStatus('Camera error: ' + name, true);
  }
}

function stopScanner(){
  scanning = false;
  if(decodeInterval){ clearInterval(decodeInterval); decodeInterval = null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
  video.pause();
  video.srcObject = null;
  startBtn.style.display = 'inline-block';
  stopBtn.style.display = 'none';
  flipBtn.style.display = 'none';
  torchBtn.style.display = 'none';
  setStatus('stopped');
}

async function flipCamera(){
  useFacing = (useFacing === 'environment') ? 'user' : 'environment';
  setStatus('Switching camera...');
  stopScanner();
  setTimeout(()=>startScanner(), 250);
}

async function toggleTorch(){
  if(!currentTrack) return;
  try {
    const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
    if(!caps || !caps.torch) { setStatus('Torch not supported', true); return; }
    const settings = currentTrack.getSettings ? currentTrack.getSettings() : {};
    const newTorch = !(settings.torch || false);
    await currentTrack.applyConstraints({ advanced: [{ torch: newTorch }] });
    torchBtn.textContent = newTorch ? 'Torch ON' : 'Torch';
  } catch(e){
    console.warn('torch err', e);
    setStatus('Torch failed', true);
  }
}

/* manual open */
manualGo.addEventListener('click', () => {
  const v = manualInput.value.trim();
  if(!v){ setStatus('Please paste the pass code', true); return; }
  setStatus('Validating manual code...');
  showLoader();
  verifyId(v).then(ok=>{
     hideLoader();
    if(ok === true) window.location.href = GOOGLE_FORM_PREFILL_URL + encodeURIComponent(v);
    else if(ok === false) showInvalidModal('Manual code is not recognized.');
    else showInvalidModal('Network error during validation.');
  });
});

/* UI wiring */
startBtn.addEventListener('click', startScanner);
stopBtn.addEventListener('click', stopScanner);
flipBtn.addEventListener('click', flipCamera);
torchBtn.addEventListener('click', toggleTorch);
retryBtn.addEventListener('click', () => { invalidModal.classList.remove('show'); lastScanned = null; startScanner(); });
manualBtn.addEventListener('click', () => { invalidModal.classList.remove('show'); manualInput.focus(); });
openFormBtn.addEventListener('click', () => validModal.classList.remove('show'));
scanAgainBtn.addEventListener('click', () => { validModal.classList.remove('show'); lastScanned = null; startScanner(); });

/* init */
if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
  setStatus('Camera not supported by this browser. Use Chrome (Android) or modern Safari (iOS).', true);
} else {
  setStatus('idle — Tap Start scanner. Rear camera is preferred.');
}

/* close modals with escape */
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') { validModal.classList.remove('show'); invalidModal.classList.remove('show'); }
});
</script>
</body>
</html>

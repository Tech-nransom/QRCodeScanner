<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner → Google Form</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 18px; max-width: 720px; margin: auto; color:#111; }
    h1 { font-size: 1.25rem; margin-bottom: 6px; }
    p.lead { margin-top:0; color:#444; font-size:0.95rem; }
    #reader { width:100%; max-width:420px; margin: 12px auto; }
    #controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:white; cursor:pointer; }
    button.primary { background:#0b6cff; color:white; border-color:#0b6cff; }
    #result { margin-top:12px; font-weight:600; }
    #manual { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    input[type="text"]{ padding:8px; border-radius:8px; border:1px solid #ccc; flex:1; min-width: 160px; }
    footer { margin-top:20px; font-size:0.85rem; color:#666; }
  </style>
</head>
<body>

  <h1>Scan QR → Register</h1>
  <p class="lead">Open this page on mobile, tap <strong>Start scanner</strong>, scan a code — you'll be redirected to the Google Form with the scanned code prefilled.</p>

  <div id="reader"></div>

  <div id="controls">
    <button id="startBtn" class="primary">Start scanner</button>
    <button id="stopBtn" style="display:none">Stop scanner</button>
    <button id="switchCameraBtn" style="display:none">Switch camera</button>
  </div>

  <div id="result" aria-live="polite"></div>

  <div id="manual">
    <input id="manualInput" type="text" placeholder="Or type/paste QR code value manually">
    <button id="manualGo">Open Form</button>
  </div>

  <footer>
    <div>Hosted on GitHub Pages (static). Camera access only in your browser and stays local to the device.</div>
  </footer>

<script>
// Google Form prefill base URL — with your field ID
const GOOGLE_FORM_PREFILL_URL = "https://docs.google.com/forms/d/e/1FAIpQLScpuyjR36_M689jdxRBxgpSXa-J6UasLwsxJ-NTFfxzzYiBWg/viewform?usp=pp_url&entry.298461775=";

let html5QrcodeScanner = null;
let currentCameraId = null;
let cameras = [];

const resultEl = document.getElementById("result");
const readerEl = document.getElementById("reader");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const switchCameraBtn = document.getElementById("switchCameraBtn");
const manualInput = document.getElementById("manualInput");
const manualGo = document.getElementById("manualGo");

function showMessage(msg, isError=false) {
  resultEl.textContent = msg;
  resultEl.style.color = isError ? "#b00020" : "#0b6cff";
}

function redirectToForm(val) {
  const url = GOOGLE_FORM_PREFILL_URL + encodeURIComponent(val);
  showMessage("Scanned: " + val + " — redirecting...");
  setTimeout(() => window.location.href = url, 500);
}

function onScanSuccess(decodedText) {
  if(html5QrcodeScanner) {
    try { html5QrcodeScanner.clear(); } catch(e){}
  }
  redirectToForm(decodedText);
}

function onScanError(err) {
  // silent
}

async function getCameras() {
  try {
    const devs = await Html5Qrcode.getCameras();
    cameras = devs || [];
    if(cameras.length > 0) currentCameraId = cameras[0].id;
  } catch(e) {
    cameras = [];
  }
}

async function startScanner(cameraId) {
  if(!html5QrcodeScanner) {
    html5QrcodeScanner = new Html5Qrcode("reader");
  }
  const config = { fps: 10, qrbox: { width: 250, height: 250 }};
  try {
    await html5QrcodeScanner.start(
      cameraId ? { deviceId: { exact: cameraId } } : undefined,
      config,
      onScanSuccess,
      onScanError
    );
    startBtn.style.display = "none";
    stopBtn.style.display = "inline-block";
    if(cameras.length > 1) switchCameraBtn.style.display = "inline-block";
    showMessage("Scanning… point the camera at the QR code");
  } catch(err) {
    showMessage("Cannot start camera — check permissions.", true);
  }
}

async function stopScanner() {
  if(html5QrcodeScanner) {
    try { await html5QrcodeScanner.stop(); await html5QrcodeScanner.clear(); } catch(e){}
  }
  startBtn.style.display = "inline-block";
  stopBtn.style.display = "none";
  switchCameraBtn.style.display = "none";
  showMessage("");
}

startBtn.addEventListener("click", async () => {
  await getCameras();
  await startScanner(currentCameraId);
});

stopBtn.addEventListener("click", async () => {
  await stopScanner();
});

switchCameraBtn.addEventListener("click", async () => {
  if(cameras.length < 2) return;
  const idx = cameras.findIndex(c => c.id === currentCameraId);
  currentCameraId = cameras[(idx + 1) % cameras.length].id;
  await stopScanner();
  await startScanner(currentCameraId);
});

manualGo.addEventListener("click", () => {
  const v = manualInput.value.trim();
  if(!v) return showMessage("Paste or type QR value.", true);
  redirectToForm(v);
});
</script>

</body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Activate Pass</title>

    <!-- Bootstrap CSS (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- confetti lib -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

    <style>
      html,body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; font-size:16px; -webkit-text-size-adjust:100%;}
      body{background:#f6f8fa;padding:16px;display:flex;align-items:flex-start;justify-content:center;min-height:100vh}
      .card { width:100%; max-width:760px; border-radius:14px; box-shadow:0 8px 30px rgba(16,24,40,0.07); overflow:hidden; }
      .card-body { padding:18px; }
      .pass-code { background:#f3f4f6; border-radius:8px; padding:8px 10px; font-weight:600; text-align:center; letter-spacing:0.6px; }
      .required-star { color:#dc2626; margin-left:4px; font-weight:700; }
      .form-control { padding:12px 14px; border-radius:10px; }
      .form-select { padding:10px 14px; border-radius:10px; }
      .btn-primary { background: linear-gradient(180deg,#2563eb,#1e40af); border: none; box-shadow:0 8px 20px rgba(37,99,235,0.12); font-weight:700; padding:12px 16px; border-radius:10px; }
      .btn-primary:disabled { opacity:0.65; cursor:not-allowed; }
      .helper { font-size:0.92rem; color:#6b7280; }
      .success-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; padding:20px; }
      .success-card { background:white; border-radius:14px; padding:22px; box-shadow:0 18px 50px rgba(16,24,40,0.12); text-align:center; max-width:520px; width:100%; }
      .check { width:86px;height:86px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,#e6f9f3,#dff7ef);border:1px solid rgba(22,163,74,0.08); transform:scale(.6); opacity:0; animation:checkPop .56s cubic-bezier(.2,.9,.3,1) forwards .12s; margin:0 auto; }
      @keyframes checkPop { 0%{opacity:0; transform:scale(.6)} 60%{opacity:1; transform:scale(1.12)} 100%{transform:scale(1)} }
      #confetti-canvas { position: fixed; inset: 0; width:100vw; height:100vh; pointer-events:none; z-index:2000; display:none; }
      @media(min-width:720px){ .card-body { padding:26px; } }
    </style>
  </head>

  <body>
    <div class="card" id="mainCard" style="display:none">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h4 class="mb-0">Activate Pass</h4>
            <div class="helper">BK Shivani: Healing From Within</div>
          </div>
          <div style="min-width:110px;text-align:right">
            <div class="small helper mb-1">Pass code</div>
            <div id="passDisplay" class="pass-code" aria-live="polite"></div>
          </div>
        </div>

        <form id="regForm" novalidate>
          <input type="hidden" id="passCode" name="passCode" value="">

          <div class="row g-2 mb-2">
            <div class="col-12 col-md-6">
              <label for="firstName" class="form-label">First name<span class="required-star">*</span></label>
              <input id="firstName" name="firstName" type="text" class="form-control" autocomplete="given-name" required inputmode="text" placeholder="Sanket" />
            </div>

            <div class="col-12 col-md-6">
              <label for="lastName" class="form-label">Last name<span class="required-star">*</span></label>
              <input id="lastName" name="lastName" type="text" class="form-control" autocomplete="family-name" required inputmode="text" placeholder="Patil" />
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-6 col-md-3">
              <label for="age" class="form-label">Age<span class="required-star">*</span></label>
              <input id="age" name="age" type="number" class="form-control" min="0" max="120" required inputmode="numeric" placeholder="28" />
            </div>

            <div class="col-6 col-md-3">
              <label for="gender" class="form-label">Gender</label>
              <select id="gender" name="gender" class="form-select" aria-label="Gender">
                <option value="">Prefer not to say</option>
                <option>Female</option>
                <option>Male</option>
                <option>Other</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label for="occupation" class="form-label">Occupation<span class="required-star">*</span></label>
              <select id="occupation" name="occupation" class="form-select" required aria-required="true">
                <option value="">Choose â€” Student / Professional / Other</option>
                <option>Student</option>
                <option>Professional</option>
                <option>Entrepreneur</option>
                <option>Freelancer</option>
                <option>Retired</option>
                <option>House Wife</option>
                <option>Doctor</option>
                <option>Other</option>
              </select>

              <div id="occupationWrap" class="mt-2" style="display:none">
                <input id="occupationOther" name="occupationOther" class="form-control" placeholder="Tell us your occupation" />
              </div>
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-12 col-md-6">
              <label for="pincode" class="form-label">Pincode / ZIP<span class="required-star">*</span></label>
              <input id="pincode" name="pincode" type="text" class="form-control" inputmode="numeric" pattern="^[0-9]{4,8}$" required placeholder="560001" />
              <div class="helper mt-1">4â€“8 digits.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="whatsapp" class="form-label">WhatsApp number<span class="required-star">*</span></label>
              <input id="whatsapp" name="whatsapp" type="tel" class="form-control" inputmode="tel" pattern="^\+?[0-9\s\-]{7,20}$" required placeholder="+91 98765 43210" />
              <div class="helper mt-1">Include country code (e.g. +91) for faster contact.</div>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-12">
              <label for="email" class="form-label">Email<span class="required-star">*</span></label>
              <input id="email" name="email" type="email" class="form-control" required placeholder="you@example.com" inputmode="email" />
            </div>
          </div>

          <div class="d-grid gap-2 mb-2">
            <button id="submitBtn" class="btn btn-primary" type="submit" disabled aria-disabled="true">
              <span id="btnLoader" class="spinner-border spinner-border-sm text-light me-2" role="status" style="display:none"></span>
              <span id="btnText">Activate pass</span>
            </button>
          </div>

          <div id="resultMsg" class="mb-2" aria-live="polite"></div>
        </form>
      </div>
    </div>

    <div id="missingWrap" style="max-width:760px;margin:18px auto;display:none">
      <div class="alert alert-warning">No pass code found in the URL. Make sure you scanned a valid QR code.</div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>

    <script>
      // ---------- CONFIG ----------
      // Replace this with your Apps Script 'exec' URL (web app) that implements doPost/doOptions
      const APPS_SCRIPT_EXEC_URL = "https://script.google.com/macros/s/AKfycbwnIZMx_vwhd9qAQSCvCgswi415b3M56tNA8yCBN4rCVFzg-4QNSAImetbcdoRPAvgAQw/exec";
      // ----------------------------

      // helpers / elements
      const mainCard = document.getElementById('mainCard');
      const missingWrap = document.getElementById('missingWrap');
      const passDisplay = document.getElementById('passDisplay');
      const passCodeInput = document.getElementById('passCode');

      const fn = document.getElementById('firstName');
      const ln = document.getElementById('lastName');
      const ageEl = document.getElementById('age');
      const whatsapp = document.getElementById('whatsapp');
      const pincode = document.getElementById('pincode');
      const occupation = document.getElementById('occupation');
      const occupationWrap = document.getElementById('occupationWrap');
      const occupationOther = document.getElementById('occupationOther');
      const email = document.getElementById('email');
      const submitBtn = document.getElementById('submitBtn');
      const btnLoader = document.getElementById('btnLoader');
      const btnText = document.getElementById('btnText');
      const resultMsg = document.getElementById('resultMsg');

      const whatsappPattern = /^\+?[0-9\s\-]{7,20}$/;
      const pincodePattern = /^[0-9]{4,8}$/;

      // initialize: read pass from URL
      function getParam(name){
        const ps = new URLSearchParams(location.search);
        return ps.get(name) || ps.get(name.toLowerCase());
      }
      const PASS = (getParam('pass') || getParam('passCode') || '').trim();

      if (!PASS) {
        missingWrap.style.display = 'block';
        mainCard.style.display = 'none';
      } else {
        passDisplay.textContent = PASS;
        passCodeInput.value = PASS;
        mainCard.style.display = 'block';
        missingWrap.style.display = 'none';
      }

      // occupation toggle
      occupation.addEventListener('change', () => {
        if (occupation.value === 'Other') {
          occupationWrap.style.display = 'block';
          occupationOther.setAttribute('required', 'required');
          setTimeout(()=>occupationOther.focus(), 220);
        } else {
          occupationWrap.style.display = 'none';
          occupationOther.removeAttribute('required');
          occupationOther.value = '';
        }
        updateButtonState();
      });

      function showStatus(msg, type='error') {
        resultMsg.innerHTML = '';
        const div = document.createElement('div');
        div.className = type === 'error' ? 'alert alert-danger p-2' : 'alert alert-success p-2';
        div.textContent = msg;
        resultMsg.appendChild(div);
      }
      function clearStatus(){ resultMsg.innerHTML = ''; }

      function updateButtonState(){
        const firstOk = (fn.value || '').trim().length > 0;
        const lastOk = (ln.value || '').trim().length > 0;
        const ageOk = !!(ageEl.value && Number(ageEl.value) >= 0 && Number(ageEl.value) <= 120);
        const waOk = whatsappPattern.test((whatsapp.value || '').trim());
        const pinOk = pincodePattern.test((pincode.value || '').trim());
        const occVal = (occupation.value || '').trim();
        const occOk = occVal && (occVal !== 'Other' || (occupationOther.value || '').trim().length > 0);

        const enable = firstOk && lastOk && ageOk && waOk && pinOk && occOk && PASS;
        submitBtn.disabled = !enable;
        submitBtn.setAttribute('aria-disabled', String(!enable));
      }

      let deb;
      function onInput(){ clearTimeout(deb); deb = setTimeout(() => { updateButtonState(); clearStatus(); }, 120); }
      [fn,ln,ageEl,whatsapp,pincode,occupation,occupationOther].forEach(el=>el.addEventListener('input', onInput));
      window.addEventListener('load', updateButtonState);

      // confetti
      function launchConfetti(duration = 2200){
        const end = Date.now() + duration;
        const canvas = document.getElementById('confetti-canvas');
        if (canvas) canvas.style.display = 'block';
        (function frame(){
          if (Date.now() > end) { if (canvas) setTimeout(()=>canvas.style.display='none',300); return; }
          try {
            confetti({ particleCount: 24, startVelocity: 35, spread: 80, ticks: 60, origin: { x: Math.random(), y: Math.random() * 0.2 } });
            confetti({ particleCount: 16, startVelocity: 18, spread: 120, ticks: 60, origin: { x: Math.random(), y: Math.random() * 0.2 } });
          } catch(e){}
          setTimeout(frame, 250);
        })();
      }

      function showSuccessScreen(message){
        document.body.innerHTML = `
          <canvas id="confetti-canvas" style="position:fixed;inset:0;width:100vw;height:100vh;pointer-events:none;z-index:2000"></canvas>
          <div class="success-wrap">
            <div class="success-card">
              <div class="check" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 6L9 17l-5-5"></path>
                </svg>
              </div>
              <h4 style="margin-top:12px">ðŸŽ‰ Pass Activated!</h4>
              <div class="helper" style="margin-top:8px">${escapeHtml(message || 'Your pass is now active.')}</div>
            </div>
          </div>`;
        setTimeout(()=>launchConfetti(2400), 160);
      }

      function escapeHtml(s){ if (!s) return ''; return s.toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

      function stopLoading(text='Activate pass'){
        btnLoader.style.display = 'none';
        btnText.textContent = text;
        submitBtn.classList.remove('disabled');
        submitBtn.removeAttribute('aria-disabled');
        updateButtonState();
      }
      function startLoading(){
        btnLoader.style.display = 'inline-block';
        btnText.textContent = 'Processing...';
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-disabled','true');
        clearStatus();
      }

      // Submit handler
      document.getElementById('regForm').addEventListener('submit', async function(e){
        e.preventDefault();
        if (submitBtn.disabled) return;

        // final checks
        if (!fn.value.trim() || !ln.value.trim()) { showStatus('First and last name required.'); return; }
        if (!whatsappPattern.test(whatsapp.value.trim())) { showStatus('WhatsApp number looks invalid.'); return; }
        if (!pincodePattern.test(pincode.value.trim())) { showStatus('Pincode must be 4â€“8 digits.'); return; }
        if (!ageEl.value || Number(ageEl.value) < 0 || Number(ageEl.value) > 120) { showStatus('Enter a valid age.'); return; }
        if (!occupation.value || (occupation.value === 'Other' && !occupationOther.value.trim())) { showStatus('Please enter your occupation.'); return; }
        if (!email.value.trim()) { showStatus('Email is required.'); return; }

        startLoading();

        const payload = {
          passCode: PASS,
          firstName: fn.value.trim(),
          lastName: ln.value.trim(),
          age: ageEl.value.trim(),
          gender: document.getElementById('gender').value || '',
          pincode: pincode.value.trim(),
          whatsapp: whatsapp.value.trim(),
          email: email.value.trim(),
          occupation: occupation.value === 'Other' ? (occupationOther.value.trim()) : occupation.value,
          occupationOther: occupationOther.value.trim(),
          heardFrom: '', heardOther: ''
        };

        // If page is still running inside Apps Script (rare after static hosting), keep compatibility
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          const start = Date.now();
          google.script.run.withSuccessHandler(function(res){
            const ms = Date.now() - start;
            const minDelay = Math.max(0, 450 - ms);
            setTimeout(()=> {
              if (res && res.success) {
                showSuccessScreen(res.message || 'Pass activated');
              } else {
                stopLoading();
                showStatus((res && res.message) || 'Something went wrong. Try again.');
              }
            }, minDelay);
          }).withFailureHandler(function(err){
            stopLoading();
            showStatus('Server error. Please try again later.');
            console.error('submitRegistration error:', err);
          }).submitRegistration(payload);
          return;
        }

        // Otherwise POST to your Apps Script doPost endpoint (recommended static flow)
        try {
          const resp = await fetch("https://script.google.com/macros/s/AKfycbwnIZMx_vwhd9qAQSCvCgswi415b3M56tNA8yCBN4rCVFzg-4QNSAImetbcdoRPAvgAQw/exec", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          // if not JSON, treat as error
          const json = await resp.json().catch(()=>({ success:false, message:'Invalid server response' }));

          if (json && json.success) {
            showSuccessScreen(json.message || 'Pass activated');
          } else {
            stopLoading();
            showStatus((json && (json.message || json.error)) || 'Activation failed. Please try again.');
          }
        } catch (err) {
          console.error('POST error', err);
          stopLoading();
          showStatus('Network/server error. Try again.');
        }
      });
    </script>
  </body>
</html>
